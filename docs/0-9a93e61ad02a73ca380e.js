(window.webpackJsonp=window.webpackJsonp||[]).push([[0,1,2,5,6],[,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"IDB",function(){return i});const i=(()=>{const e=async()=>null;let t=e,s=e,i=e,n=e,a=e;if(indexedDB){class e{constructor(e="WebCache",t="KeyStore"){this.storeName=t,this._dbase=new Promise((s,i)=>{const n=indexedDB.open(e,1);n.onerror=(e=>(console.log(e),s(null))),n.onsuccess=(()=>{s(n.result)}),n.onupgradeneeded=(()=>{n.result.createObjectStore(t)})})}__IDBAct__(e,t){return this._dbase.then(s=>new Promise((i,n)=>{const a=s.transaction(this.storeName,e);a.oncomplete=(()=>i()),a.onabort=a.onerror=(()=>n()),t(a.objectStore(this.storeName))})).catch(e=>(console.log(e),null))}}let r;const o=()=>r||new e;t=((e,t=o())=>{let s;return t.__IDBAct__("readonly",t=>{s=t.get(e)}).then(()=>s.result).catch(e=>(console.log(e),null))}),s=((e,t,s=o())=>{try{return s.__IDBAct__("readwrite",s=>{s.put(t,e)})}catch(e){return null}}),a=((e,t=o())=>{try{t.__IDBAct__("readwrite",t=>{t.delete(e)})}catch(e){return null}}),n=((e=o())=>{try{return console.warn("clearing Store:",e),e.__IDBAct__("readwrite",e=>{e.clear()})}catch(e){return e}}),i=((e=o())=>{const t=[];return e.__IDBAct__("readonly",e=>{(e.openKeyCursor||e.openCursor).call(e).onsuccess=function(){this.result&&(t.push(this.result.key),this.result.continue())}}).then(()=>t).catch(e=>null)})}return{get:t,set:s,__clear__:n,keys:i,del:a}})()},function(e,t,s){"use strict";s.r(t),s.d(t,"MatNotify",function(){return n});var i=s(0);class n extends HTMLElement{createTemplate(){const e=i.$.create("div",{class:"bxcs"}),t=i.$.create("div",{class:"__div",textContent:this.title}),s=i.$.create("div",{textContent:this.body,class:"body"}),n=i.$.create("button",{class:"action",textContent:this.action1}),a=i.$.create("div");e.appendChild(t),e.appendChild(s),e.appendChild(a),a.appendChild(n);const r=i.$.create("template");return r.innerHTML=e.outerHTML+"<style>.action{cursor:pointer}.__div{font-weight:bold}.action,.bxcs{background-color:#fff}input{width:90%;border-radius:20px;border:2px solid #e3e3e3;padding:4px;outline:0}.bxcs{position:fixed;width:85%;margin:auto;right:0;left:0;top:2px;border-radius:10px;height:auto;padding:10px;z-index:20;box-shadow:0 2px 8px 0 #04040426}.action{color:#4749e4;font-weight:700;border:none;outline:0}</style>",r}startTick(e=4e3){setTimeout(()=>this.remove(),e)}constructor(e,t,s,n,a,r=null,o){super(),this.title=e,this.body=t,this.bodyOnClick=s,this.action1=n,this.action1onClick=a||{},this.input=r;const c=this.createTemplate(),d=this.attachShadow({mode:"open"});if(d.appendChild(c.content.cloneNode(!0)),d.querySelector(".bxcs").onclick=s,this.action1onClick.showInput){let e;const t=d.querySelector(".action");this.input&&(e=i.$.create("input",{id:"input"})),e.onkeydown=(s=>{if(13===s.keyCode)return e.replaceWith(t),o(s),this.remove()}),t.onclick=(()=>{t.replaceWith(e),e.focus(),this.remove()})}else d.querySelector(".action").onclick=(e=>(a(e),this.remove()))}}Object(i.safeDefine)("mat-notify",n)},function(e,t,s){"use strict";s.r(t),s.d(t,"MessageElement",function(){return r});var i=s(0),n=s(17),a=s.n(n);class r extends HTMLElement{constructor({message:e,sender:t,receiver:s,stamp:i,read:n,rstamp:a,seen_read:r,edited:o},c,d,h){super(),this.message=e,"string"!=typeof e&&(this.media=this.message.media,this.mediaURL=this.message.mediaURL),this.sender=t,this.receiver=s,this.stamp=i,this.edited=o,this.read=n,this.rstamp=a,this.seen_read=r,this.$id=c;const l=document.createElement("template");this.user=h,l.innerHTML="<style>[message]{text-align:justify;margin:5px;width:fit-content;border-radius:15px;max-width:45%;display:flex;padding:6px;cursor:pointer;overflow-wrap:break-word;word-break:break-word}[message].sent{background:#d2e3fc;color:#174ea6;margin-left:auto}[message].received{margin-right:auto;background-color:#f1f3f4;color:#000000de}[time]{display:flex;font-weight:200;color: #0000005e;font-size:12px;margin:10px;-webkit-transition:.2s;transition:.2s;-webkit-transform:translate(0,0);transform:translate(0,0)}[time].sent{flex-direction:row-reverse;}[time].received{flex-direction:row}</style><div message></div><div time></div>";const _=this.attachShadow({mode:"open"});_.appendChild(l.content.cloneNode(!0)),this.msg=_.querySelector("div[message]"),this.time=_.querySelector("div[time]"),this.setAttribute("msg-id",this.$id),this.sender===d?(this.msg.classList.add("received"),this.time.classList.add("received")):this.sender===h&&(this.msg.classList.add("sent"),this.time.classList.add("sent"));try{this.msg.appendChild(this._messageOrMedia())}catch(e){console.log(e,this)}this.time.textContent=this._GetInformativeTime(),this.onclick=(()=>{})}setRead(e,t){this.read=e,this.rstamp=t,this.shadowRoot.querySelector("div[time]").textContent=this._GetInformativeTime()}_messageOrMedia(){if(this.media){const e=document.createElement("img");return e.src=a.a,this.msg.onclick=(()=>{const e=document.createElement("a");e.href=this.mediaURL,e.target="__blank",e.click()}),e}if(this.message)return document.createTextNode(this.message)}_GetInformativeTime(){let e,t="",s="";return this.edited&&(s="[edited]"),this.sender!==this.user?e=this.stamp:this.read?(this.read&&(t="read "),e=this.rstamp):(t="sent ",e=this.stamp),s+t+Object(i.stampFormat)(e)}}Object(i.safeDefine)("text-message",r)},,function(e,t,s){"use strict";s.r(t),s.d(t,"peerConnectionConfig",function(){return c}),s.d(t,"BaseManager",function(){return h}),s.d(t,"MessageManager",function(){return l}),s.d(t,"getChatData",function(){return _}),s.d(t,"updateDb",function(){return u});var i=s(2),n=s(0),a=s(6),r=s(5),o=s(7);const c={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},d=e=>n.$.create("div",{notification:!0,textContent:e});class h{static async validateChatId(e){const t=await i.Requests.post("/api/validate-chat",!0,Object(n.urlencode)({chat_id:e})),s=await t.json();if(s.error)return{error:s.error};const{HERE:a,chat_with:r,chat_id:o,is_online:c}=s;return{user:a,chat_id:o,peer:r,is_online:c}}_onIceCandidate({candidate:e}){if(e&&this._pc)return this._socket.send({type:"rtc_data",data:{icecandidate:e},peer:this._peer})}_iceStateChange(){this._pc.oniceconnectionstatechange=(async e=>{try{if(this.__unrendering__)return;const t=this._pc.iceConnectionState;if(["closed","disconnected","failed"].includes(t)){console.log("Connection is Dead.."),this._isOfferer=null,this._pc=null,this._dc=null,this.__USEWEBSOCKETFALLBACK__=!0,setTimeout(async()=>{await this._startConn()},50);const e=await _(this._chat_id);this.peer=e.peer,this._is_online=e.is_online,this.updateUI&&this.updateUI()}}catch(e){}})}_onDataChannel(){console.log(`[isOfferer=${this._isOfferer}]started data channel`,this._dc),this._dc.addEventListener("message",({data:e})=>n.Events.emit("chat_message",e)),this.__USEWEBSOCKETFALLBACK__=!1}async _startRTCPings(){if(this._isOfferer){this._dc=this._pc.createDataChannel(Object(n._random)());const e=await this._pc.createOffer();await this._pc.setLocalDescription(e),this._pc.onicecandidate=(e=>this._onIceCandidate(e)),this._socket.send({type:"rtc_data",data:{rtc:"offer",js:e},peer:this._peer}),n.Events.emit("on-dataChannel")}else this._pc.ondatachannel=(({channel:e})=>(this._dc=e,n.Events.emit("on-dataChannel")))}async _parseRTCData(e){if(!e)return;const{rtc:t,js:s,icecandidate:i}=e;if(i)return await this._pc.addIceCandidate(i);if("offer"===t){await this._pc.setRemoteDescription(s);const e=await this._pc.createAnswer();return await this._pc.setLocalDescription(e),this._socket.send({type:"rtc_data",data:{rtc:"answer",js:e},peer:this._peer})}"answer"===t&&await this._pc.setRemoteDescription(s)}_onWSmessage({data:e={}}){if("string"!=typeof e)return console.log("handle binary");const t=JSON.parse(e),{type:s,data:i,meta:r}=t;if(r.from!==this._peer&&r.from!==this._user){if("start_chat"!==s&&"online_status"!==s)return;console.log(`new chat offer from ${r.from}`);const e=new a.MatNotify("Start a Chat",`${r.from} is ready to chat!`,()=>Object(n.load)(`/chat/${i.common_chat_id}`),"Click to send a message",{showInput:1},!0,e=>{const t=e.target.value;t&&t.trim()&&this._socket.send({type:"message-relay",data:this._GenerateMessageTemplate?this._GenerateMessageTemplate(t):void 0})});return document.body.appendChild(e),e.startTick()}if(this._is_online||(this._is_online="online",this.updateUI()),"online_status"===s){const{isonline:e}=i;return this._is_online=e?"online":"offline",this.updateUI(),e?this._socket.send({type:"get_role",peer:this._peer}):void 0}if("get_role"===s)return this._socket.send({type:"send_role",data:{is_offerer:!!this._isOfferer},peer:this._peer});if("set_role"===s){if("boolean"==typeof this._isOfferer)return;return this._isOfferer=i.is_offerer,n.Events.emit("use-rtc")}if("rtc_data"===s&&this._parseRTCData(i),"message-relay"===s&&n.Events.emit("chat_message",i),"get-update"==s){const e=i.msgid;this.getElementByMessageId(e)&&this._socket.send({type:"update",peer:this._peer,data:{update_type:"read-update",details:{chat_id:this._chat_id,read:e,rstamp:Object(n._getTime)()}}})}"chat-update"===s&&this._updateMessages(i)}get currentChatData(){return{chatID:this.chatID,user:this._user,peer:this._peer,is_online:this._is_online}}async _startConn(){if(this.updateUI(),n.Events.listen("use-rtc",e=>e?this._startRTCPings():this._canUseRTC=!1),this._pc=null,this._isOfferer=null,this._pc=new RTCPeerConnection(c),this._pc.oniceconnectionstatechange=(e=>this._iceStateChange(e)),this._dc=null,this._socket.isUsable&&this._socket.socket||await this._socket.startConn("_/data/"),this._socket.send({type:"start_chat",peer:this._peer}),this._socket.onmessage=(e=>this._onWSmessage.call(this,e)),"offline"==this._is_online)return console.log("use websockets"),this._canUseRTC=!1}get supportsRTC(){return!!window.RTCPeerConnection&&!!window.RTCDataChannel}get UseRTC(){return this.supportsRTC&&(this.PeerObject||{}).isOnline&&this._canUseRTC}}class l extends h{updateUI(){try{const{peer:e,is_online:t}=this.currentChatData;this.peerbox=Object(n.getElement)(this._textarea,"peername"),this.peerstatus=Object(n.getElement)(this._textarea,"peerstatus"),this.peerbox.$$element.textContent=e,this.peerstatus.$$element.textContent=t}catch(e){}}_onUserMessage({detail:e}){let t;try{t=Object(n.isKeyValObj)(e)?e:JSON.parse(e)}catch(e){return console.warn(e)}const{type:s,sender:i,data:a}=t;if("message-relay"===s){this._lastMessageID+=1;const e={},t={...a,sender:i,receiver:a.peer};e[this._lastMessageID]=t,console.log("UPDATE-----\x3e",e),u(this._chat_id,e);const s=new o.MessageElement(t,this._lastMessageID,this._peer,this._user);return this._textarea.$$element.appendChild(s),s.scrollIntoView(),this._lastMessageID}"typing"===s&&i===this._peer&&(clearTimeout(this.___typingTimeout),this.peerstatus.$$element.textContent="typing",this.___typingTimeout=setTimeout(()=>{this.peerstatus.$$element.textContent=this._is_online},700))}_GenerateMessageTemplate(e,t=Object(n._getTime)()){if(!e)throw new Error("Invalid Values");const s={type:"message-relay",peer:this._peer,sender:this._user,data:{chat_id:this._chat_id,msgid:this._lastMessageID,stamp:t,peer:this._peer}};return s.data.message=e,s}_sendTypingIndicator(){this._dc&&"open"===this._dc.readyState&&this._dc.send(JSON.stringify({type:"typing",sender:this._user}))}_sendMessageAndUpdateDataBase(e){const t=this._GenerateMessageTemplate(e);this._input.$$element.value="",this.__USEWEBSOCKETFALLBACK__?this._socket.send(t):(console.log(this._dc),this._dc.send(JSON.stringify(t)));const s=this._onUserMessage({detail:{...t,sender:this._user,receiver:this._peer}});this._sendServerPing(e,s)}async _sendServerPing(e,t){const s={chat_id:this._chat_id,data:{sender:this._user,receiver:this._peer,message:e,stamp:Object(n._getTime)()}};console.log("sending to server---\x3e",s);const a=await i.Requests.post("/api/instant-message/",!0,JSON.stringify({details:s}),{"content-type":"application/json"}),r=(await a.json()).data;parseInt(r)!==parseInt(t)&&console.log("check for errors")}_setUpDataInputListeners(){this._input.events.keydown=(e=>(function(e,t,s){return 85===e.keyCode&&e.ctrlKey?(e.preventDefault(),this.$$element.value=this.$$element.value.slice(this.$$element.selectionStart,this.$$element.value.length),this.$$element.setSelectionRange(0,0)):13===e.keyCode?(this.attrs.value||"").trim()&&t(this.$$element.value):this.attrs.value=this.$$element.value,s()}).call(this._input,e,e=>this._sendMessageAndUpdateDataBase.call(this,e),()=>this._sendTypingIndicator.call(this))),this._input.events.keyup=(()=>(function(){const e=(this.$$element.value||"").trim(),t=Object(n.getElement)(this,"sendbtn"),s=Object(n.getElement)(this,"attachbtn");return e?s.$$element.parentElement&&(s.$$element.style.transform="translate(200px,0px)",setTimeout(()=>(t.add(),s.remove()),170)):(s.add(),t.remove(),setTimeout(()=>s.$$element.style.transform="translate(0px,0px)",20)),this.attrs.value=this.$$element.value}).call(this._input)),this._input.reRender(),this._submit_button.events=this._submit_button.events||{},this._submit_button.events.click=(()=>this._sendMessageAndUpdateDataBase.call(this,this._input.$$element.value)),this._submit_button.reRender()}async _updateMessages(e){const{update_type:t,msg:s,rstamp:i,chat_id:n}=e;if("read"===t){const e=await r.IDB.get(n);if(e){const t=e.chats;t[s].read=!0,t[s].rstamp=i,e.chats=t,await r.IDB.set(n,e),this.getElementByMessageId(s).setRead(!0,i)}}}_renderFetchedMessages(e){const t=Object.keys(e),s=document.createElement("div");for(const i of t){const t=e[i];if(this._lastMessageID=parseInt(i),!this._latestMessageElement){const e=new o.MessageElement(t,i,this._peer,this._user);s.appendChild(e),this._textarea.$$element.appendChild(s)}}}async _getPreviousMessages(){const e=(await r.IDB.get(this._chat_id)||{}).chats||{};console.log("idb data--\x3e",e),this._renderFetchedMessages(e),this._lastMessageID=Object.keys(e).length-1,this._latestMessageElement&&this._latestMessageElement.scrollIntoView();const t=await i.Requests.post("/api/updates/",!0,Object(n.urlencode)({chat_id:this._chat_id,fetch_from:this._lastMessageID})),s=(await t.json()).message_data.messages;this._renderFetchedMessages(s),await u(this._chat_id,s),this._latestMessageElement&&this._latestMessageElement.scrollIntoView()}_sendBinaryFile(e){this.__USEWEBSOCKETFALLBACK__&&d()}get _latestMessageElement(){if(this._lastMessageID)return this.getElementByMessageId(this._lastMessageID)}getElementByMessageId(e){return n.$.q(`text-message[msg-id="${e}"]`)}constructor(e,t,s=Object(i.getSocket)()){super(),n.Events.destroyAll(),n.Events.listen("attach-img",({detail:e})=>this._sendBinaryFile.call(this,e)),n.Events.listen("chat_message",e=>this._onUserMessage.call(this,e)),n.Events.listen("on-dataChannel",e=>this._onDataChannel(e)),n.Events.listen("unmount-router",()=>{n.Events.destroyAll(),this._pc&&(this._socket.close(),this.__unrendering__=!0,this._pc.close(),this._pc=this._dc=this._peer=this._chat_id=this._isOfferer=null)}),this.__unrendering__=!1,this.__USEWEBSOCKETFALLBACK__=!0,this._isOfferer=null,this._canUseRTC=!0;const{user:a,chat_id:r,peer:o,is_online:c}=e;this._user=a,this._peer=o,this._is_online=c,this._chat_id=r,this._textarea=t,this._input=Object(n.getElement)(this._textarea,"chat_type"),this._submit_button=Object(n.getElement)(this._textarea,"sendbtn"),this._socket=s,this._getPreviousMessages(),this._startConn(),this._setUpDataInputListeners()}}async function _(e){return await l.validateChatId(e)}async function u(e,t,s=!0){const i=await r.IDB.get(e)||{};if(s){const s={...i.chats,...t};return i.chats=s,await r.IDB.set(e,i)}return i.meta=t,await r.IDB.set(e,i)}},function(e,t,s){"use strict";s.r(t);var i=s(17),n=s.n(i),a=s(18),r=s.n(a),o=s(0),c=s(9),d=s(2),h=s(5);const l={element:"div",attrs:{class:"inpbox_"},children:[{element:"input",idx:"chat_type",attrs:{class:"textBox",spellcheck:"false",autocomplete:"none"},events:{}},{element:"img",idx:"attachbtn",events:{click(){const e=o.$.create("input",{type:"file"});e.oninput=(()=>o.Events.emit("attach-img",e.files[0])),e.click()},contextmenu(e){e.preventDefault()}},attrs:{src:n.a,class:"attach-img"}},{idx:"sendbtn",element:"button",textContent:"send",attrs:{class:"send-btn"},onrender(){this.remove()}}]},_={idx:"header",element:"div",attrs:{class:"header-div"},children:[{element:"div",attrs:{style:"display:grid"},children:[{element:"div",idx:"peername",attrs:{class:"peername"}},{element:"div",idx:"peerstatus",attrs:{class:"peerstatus"}}]},{element:"div",attrs:{class:"menuimg"},children:[{element:"img",attrs:{src:r.a},events:{click(){},contextmenu:e=>e.preventDefault()}}]}]},u={element:"div",idx:"inputbox",attrs:{class:"footer"},children:[l]};t.default={route:"/chat/",element:"div",attrs:{},async beforeRender(e){const t=await Object(d.noAuth)(this.currentRoute,this.getRouter().navData);return t?{stopExec:t}:(e||[])[0]?void 0:(this.getRouter().pushStatus(500,"No Chat ID Provided"),{stopExec:!0})},onUnmount:()=>(console.log("unmounting"),o.Events.emit("unmount-router"),document.body.style.overflow="auto",document.body.style.background=document.documentElement.style.background="#e3e3e3"),async onrender(e){const t=Object(o.getElement)(this,"contentmain");let s,i;document.body.style.overflow="hidden",document.body.style.background=document.documentElement.style.background="#fff";const n=e[0],a=o.$.create("mat-spinner",{style:"position:absolute;top:0;bottom:0;right:0;left:0;margin-top:30%"});this.getRouter().root.appendChild(a);const r=(await h.IDB.get(n)||{}).meta;r&&(a.remove(),s=!0,i=new c.MessageManager(r,t));const d=await Object(c.getChatData)(n);if(i){const e=i._is_online;i._is_online=d.is_online,"offline"!==e&&i._canUseRTC||"online"!==d.is_online||i._startConn(),i.updateUI()}const l=d;return l.is_online=void 0,a.remove(),Object(c.updateDb)(n,l,!1),!r||r.peer===d.peer&&r.chat_id===d.chat_id?d.error?this.getRouter().pushStatus(500,d.error):s?void 0:new c.MessageManager(d,t):(console.error("error!"),this.getRouter().pushStatus(500,"An Error occured while loading the chat data..please reload the page and try again"))},children:[_,{element:"div",idx:"contentmain",attrs:{class:"ChatContent"}},u]}},,,,,,,function(e,t){e.exports="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTYuNSA2djExLjVjMCAyLjIxLTEuNzkgNC00IDRzLTQtMS43OS00LTRWNWMwLTEuMzggMS4xMi0yLjUgMi41LTIuNXMyLjUgMS4xMiAyLjUgMi41djEwLjVjMCAuNTUtLjQ1IDEtMSAxcy0xLS40NS0xLTFWNkgxMHY5LjVjMCAxLjM4IDEuMTIgMi41IDIuNSAyLjVzMi41LTEuMTIgMi41LTIuNVY1YzAtMi4yMS0xLjc5LTQtNC00UzcgMi43OSA3IDV2MTIuNWMwIDMuMDQgMi40NiA1LjUgNS41IDUuNXM1LjUtMi40NiA1LjUtNS41VjZoLTEuNXoiLz48cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PC9zdmc+Cg=="},function(e,t){e.exports="data:image/svg+xml;base64,PHN2ZwogIHdpZHRoPSI0MCIKICBoZWlnaHQ9IjQwIgogIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICB2aWV3Qm94PSIwIDAgMjQgMjQiCj4KICA8cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIj48L3BhdGg+CiAgPHBhdGgKICAgIGQ9Ik0xMiA4YzEuMSAwIDItLjkgMi0ycy0uOS0yLTItMi0yIC45LTIgMiAuOSAyIDIgMnptMCAyYy0xLjEgMC0yIC45LTIgMnMuOSAyIDIgMiAyLS45IDItMi0uOS0yLTItMnptMCA2Yy0xLjEgMC0yIC45LTIgMnMuOSAyIDIgMiAyLS45IDItMi0uOS0yLTItMnoiCiAgPjwvcGF0aD4KPC9zdmc+Cg=="}]]);